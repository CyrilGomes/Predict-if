<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Consultation en cours</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="STYLES/main.css">
        <link rel="stylesheet" href="STYLES/consultation-en-cours.css">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <body style="display: none;">

        <!-- HEADER -->
        <div class="header">
            <a href="index.html" class="logo">Predict'IF</a>
            <div class="header-right" id='headerContent'>
                <a href="consultation-en-cours.html" id="currentPage">Consultation en cours</a>
                <a href="tableau-de-bord.html">Tableau de Bord</a>
                <a href="profil.html">Profil</a>
                <a href='#' class='boutonDeconnexion'>Déconnexion</a>
            </div>
        </div>

        <div class="grid-container">
            <div class="Generateur">
                <h1>Générateur de prédictions</h1>
                <div class="predictionConteneur">
                    <div class="predict">
                        <h2 class="predictTitle">Amour :</h2> 
                        <div class="slidecontainer">
                            <input type="range" min="1" max="4" value="1" class="slider" id="amourInput">
                        </div>
                    </div>
                    <textarea rows="10" cols="40" id="reponseAmour" class="responseInput"></textarea>
                    <div class="predict">
                        <h2 class="predictTitle">Santé :</h2> 
                        <div class="slidecontainer">
                            <input type="range" min="1" max="4" value="1" class="slider" id="santeInput">
                        </div>
                    </div>
                    <textarea rows="10" cols="40" id="reponseSante" class ="responseInput"></textarea>
                    <div class="predict">
                        <h2 class="predictTitle">Travail :</h2> 
                        <div class="slidecontainer">
                            <input type="range" min="1" max="4" value="1" class="slider" id="travailInput">
                        </div>
                    </div>
                    <textarea  rows="10" cols="40" id="reponseTravail" class ="responseInput"></textarea>
                    <button id='bouton-prediction'>Generer</button>
                </div>
            </div>
            <div class="Consultation">
                <h1>Consultation</h1>
                <div class="consultationContainer">
                    <h2>Client :</h2>
                    <div id="client" style="background: #FF8E71">
                        <h3 id="clientName">Jean Jean</h3>
                        <p id="signeAstrologique">Signe Astrologique : Sagittaire</p>
                        <p id="signeZodiaqueChinois">Signe Zodiaque Chinois : Dragon</p>
                        <p id="couleurPorteBonheur">Couleur porte-bonheur : Vermillion</p>
                        <p id="animalTotem">Animal Totem : Loutre</p>
                        <a href="historique.html">Voir son historique de consultation</a>
                    </div>
                    <h2>Médium incarnée :</h2>
                    <div id="medium" style="background: #04AA6D">
                        <h3 id="mediumName">Mme. Irma</h3>
                        <p id="role">cartomancière</p>
                        <p id="presentation">blablabla arnaque blablabla</p>

                    </div>
                    <h2>Commentaires :</h2>
                    <textarea rows="10" id="commentaire" ></textarea>
                    <button id="saveCommentaire">Sauvegarder</button>

                    <button id="annuler">Annuler</button>
                    <button id="boutonDemarrer">Démarrer</button>
                    <button id="boutonArreter" style="display: none;">Arrêter</button>
                    <button id="boutonTerminer" style="display: none;">Terminer</button>

                </div>
            </div>
            <div class="Historique">
                <div class="bienvenue">
                    <span>Mon historique de consultations :</span>
                </div>
                <div id="historique"></div>
            </div>
        </div>

        <script>



            // INITIALISATION
            $(document).ready(function () {

                // REDIRIGER VERS UNE AUTRE PAGE SI CE N'EST PAS LE BON USER + Historique
                $.ajax({
                    url: './ActionServlet',
                    method: 'GET',
                    data: {
                        todo: 'obtenirTypeUtilisateurCourant'
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            // Si l'utilisateur n'est pas loggé ou qu'il n'est pas un employé...
                            if (!(response.utilisateur && response.type == "employe")) {
                                // Rediriger vers l'accueil
                                window.location.replace("index.html");

                            }
                            // Si tout va bien...
                            else {
                                // Afficher la page 
                                $('body').css({"display": "block"});
                                // OBTENIR HISTORIQUE DU CLIENT PRIS EN CHARGE PAR L'EMPLOYE COURANT
                                $.ajax({
                                    url: './ActionServlet',
                                    method: 'GET',
                                    data: {
                                        todo: 'obtenirHistoriqueClientReqEmploye'
                                    },
                                    dataType: 'json'
                                })
                                        .done(function (response) {
                                            console.log(response);
                                            // Charger le nom du client 
                                            $('div.bienvenue').html(
                                                    "<span>Historique de consultations de " + response.client.prenom + " " + response.client.nom + " :</span>"
                                                    );
                                            // Charger l'historique
                                            var htmlString = "";
                                            for (var id in response.historique) {
                                                var consultation = response.historique[id];
                                                htmlString += "<div class='itemHistoriqueEmploye'>";
                                                htmlString += "<div class='contenuHistoriqueEmploye'><span class='labelHistoriqueEmploye'>Date : </span>";
                                                htmlString += "<span class='infoHistoriqueEmploye'>" + consultation.date + "</span></div>";
                                                htmlString += "<div class='contenuHistoriqueEmploye'><span class='labelHistoriqueEmploye'>Employé en charge : </span>";
                                                htmlString += "<span class='infoHistoriqueEmploye'>" + consultation.employe + "</span></div>";
                                                htmlString += "<div class='contenuHistoriqueEmploye'><span class='labelHistoriqueEmploye'>Médium incarné : </span>";
                                                htmlString += "<span class='infoHistoriqueEmploye'>" + consultation.denomination + " <i>(" + consultation.typeMedium + ")</i></span></div>";
                                                htmlString += "<div class='contenuHistoriqueEmploye'><span class='labelHistoriqueEmploye'>Commentaire : </span>";
                                                htmlString += "<span class='infoHistoriqueEmploye'>" + consultation.commentaire + "</span></div>";
                                                htmlString += "</div>";
                                            }
                                            $('#historique').html(htmlString);
                                        })
                                        .fail(function (error) {
                                            console.log('Error', error);
                                            alert("Erreur obtenirHistoriqueClientReqEmploye");
                                        });
                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })

                // OBTENIR LA CONSULTATION ATTRIBUEE
                $.ajax({
                    url: './ActionServlet',
                    method: 'GET',
                    data: {
                        todo: 'obtenirConsultationAttribuee',
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.consultation) {
                                // Remplir les informations sur le client et le médium à incarner
                                $('#clientName').html(response.client.nom + ' ' + response.client.prenom);
                                $('#signeAstrologique').html(response.client.signeAstro);
                                $('#signeZodiaqueChinois').html(response.client.signeChinois);
                                $('#couleurPorteBonheur').html(response.client.couleur);
                                $('#animalTotem').html(response.client.animalTotem);
                                $('#mediumName').html(response.medium.denomination);
                                $('#role').html(response.medium.type);
                                $('#presentation').html(response.medium.presentation);
                                $('#commentaire').val(response.commentaire);
                                // Changer l'état des boutons d'action 
                                switch (response.etat) {
                                    case "EnCours":
                                        $('#boutonDemarrer').css({"display": "none"});
                                        $('#boutonTerminer').css({"display": "none"});
                                        $('#boutonArreter').css({"display": "block"});
                                        break;
                                    case "Termine":
                                        $('#boutonDemarrer').css({"display": "none"});
                                        $('#boutonArreter').css({"display": "none"});
                                        $('#boutonTerminer').css({"display": "block"});
                                        break;
                                }
                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        });

            });

            // GENERER PREDICTION
            $('#bouton-prediction').on('click', function () {
                $('#bouton-prediction').html("Generation...");

                var valAmour = $('#amourInput').val();
                var valSante = $('#santeInput').val();
                var valTravail = $('#travailInput').val();

                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'obtenirPredictions',
                        amour: valAmour,
                        sante: valSante,
                        travail: valTravail
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.prediction) {
                                $('#reponseAmour').val(response.amour);
                                $('#reponseSante').val(response.sante);
                                $('#reponseTravail').val(response.travail);
                            } else {
                                $('#bouton-prediction').html("Erreur");
                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })
                        .always(function () { // Fonction toujours appelée
                            $('#bouton-prediction').html("Generer");
                        });

            });

            // SAUVEGARDER COMMENTAIRE
            $('#saveCommentaire').on('click', function () {
                $('#saveCommentaire').html("Sauvegarde en cours...");
                var commentaire = $('#commentaire').val();
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'sauvegarderCommentaire',
                        commentaire: commentaire,
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.statut) {
                                $('#saveCommentaire').html("Sauvegardé !");
                            } else {
                                $('#saveCommentaire').html("Erreur");
                            }
                            setTimeout(function () {
                                $('#saveCommentaire').html("Sauvegarder");
                            }, 3000);
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })
                        .always(function () {
                            $('#saveCommentaire').html("Sauvegarder");
                        });

            });

            // DEMARRER CONSULTATION
            $('#boutonDemarrer').on('click', function () {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'demarrerTerminerConsultation',
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.statut) {
                                $('#boutonDemarrer').css({"display": "none"});
                                $('#boutonArreter').css({"display": "block"});
                            } else {
                                alert("Erreur !");
                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })

            });

            // TERMINER CONSULTATION
            $('#boutonArreter').on('click', function () {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'demarrerTerminerConsultation',
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.statut) {
                                $('#boutonArreter').css({"display": "none"});
                                $('#boutonTerminer').css({"display": "block"});
                            } else {
                                alert("Erreur !");

                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })
            });

            // TERMINER/ARCHIVER CONSULTATION
            $('#boutonTerminer').on('click', function () {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'archiverConsultation',
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.statut) {
                                window.location.replace("tableau-de-bord.html");
                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        })
            });

            // ANNULER CONSULTATION
            $('#annuler').on('click', function () {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'annulerConsultation',
                    },
                    dataType: 'json'
                })
                        .done(function (response) {
                            console.log('Response', response);
                            if (response.statut) {
                                //TODO : Ajouter l'action correspondante
                                window.location.replace("tableau-de-bord.html")
                            } else {
                                alert("Erreur !");

                            }
                        })
                        .fail(function (error) {
                            console.log('Error', error);
                            alert("Erreur lors de l'appel AJAX");
                        });
            });

            // CONFIRMATION DE DEPART SI CONSULTATION TERMiNEE
            $(window).bind("beforeunload", function () {

                if($("#boutonTerminer").is(":visible")){
                    return "Etes vous sûr ?";
                }

            });




            // BOUTON DECONNEXION 
            $('body').on('click', 'a.boutonDeconnexion', function () {
                if (confirm("Êtes-vous sûrs de vouloir vous déconnecter ?")) {
                    $.ajax({
                        url: './ActionServlet',
                        method: 'POST',
                        data: {
                            todo: 'demandeDeconnexion'
                        },
                        dataType: 'json'
                    })
                            .done(function () {
                                window.location.replace("index.html");
                            })
                            .fail(function (error) {
                                console.log('Error', error);
                                alert("Nous n'avons pas pu vous déconnecter.");
                            });
                }
            });

        </script>
    </body>
</html>
